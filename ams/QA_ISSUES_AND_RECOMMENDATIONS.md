# 考勤與請假管理系統 - 問題清單與改進建議

**日期**: 2025-11-22
**版本**: Phase 2 Week 4
**測試人員**: QA 測試系統

---

## 問題清單

### 優先級分類
- **🔴 高優先級**: 影響系統核心功能或安全性，必須立即修正
- **🟡 中優先級**: 影響使用者體驗或系統效能，建議盡快修正
- **🔵 低優先級**: 輕微問題或優化建議，可排入後續版本

---

## 🔵 低優先級問題

### 1. 請假時數計算差異

**問題編號**: QA-001
**嚴重程度**: 低
**發現日期**: 2025-11-22
**影響範圍**: 請假記錄顯示

**問題描述**:
請假記錄中儲存的 `leave_hours` 為 8 小時，但實際時間差（08:30 - 17:30）為 9 小時，存在 1 小時差異。

**影響**:
- 可能造成使用者困惑（為什麼 9 小時只算 8 小時）
- 假別額度扣除可能不符合使用者預期
- 報表統計可能與使用者認知不一致

**可能原因**:
1. 業務規則扣除 1 小時午休時間
2. 使用實際工作時數而非總時數
3. 計算邏輯錯誤

**重現步驟**:
1. 查詢請假記錄 ID #1
2. 檢查 start_time: 2025-11-24 08:30:00
3. 檢查 end_time: 2025-11-24 17:30:00
4. 檢查 leave_hours: 8.00
5. 計算實際差異: 9 小時

**建議解決方案**:
1. **方案 A - 文件化現有邏輯** (推薦)
   - 在系統文件中明確說明「請假時數 = 實際工作時數，已扣除午休 1 小時」
   - 在前端顯示時加上說明文字
   - 在 API 文件中註明計算邏輯
   - **實施難度**: 低
   - **估計時間**: 1 小時

2. **方案 B - 分離總時數和工作時數**
   - 在 LeaveRecords 加入 `total_hours` 欄位（總時數，包含午休）
   - 保留 `leave_hours` 欄位（工作時數，扣除午休）
   - 前端可選擇顯示總時數或工作時數
   - **實施難度**: 中
   - **估計時間**: 4 小時（含資料庫遷移、API 修改、測試）

3. **方案 C - 加入休息時間欄位**
   - 在 LeaveRecords 加入 `break_hours` 欄位
   - 計算公式: `leave_hours = (end_time - start_time) - break_hours`
   - 更靈活，支援不同的休息時間設定
   - **實施難度**: 中
   - **估計時間**: 5 小時

**優先級理由**:
- 不影響核心功能運作
- 假別額度扣除邏輯正確
- 可能是有意設計的業務規則
- 可透過文件化快速解決

---

### 2. 缺少單元測試

**問題編號**: QA-002
**嚴重程度**: 低
**發現日期**: 2025-11-22
**影響範圍**: 程式碼品質保證

**問題描述**:
系統缺少完整的單元測試（Unit Tests），僅有資料庫層級的整合測試。

**影響**:
- 重構時缺少安全網
- 難以確保個別函數的正確性
- 新功能開發時可能引入回歸問題
- CI/CD 流程不完整

**建議解決方案**:

**階段 1: 核心功能單元測試** (1 週)
```python
# 測試範圍
- attendance/utils.py
  - test_calculate_distance()
  - test_calculate_work_hours()

- attendance/models.py
  - test_leave_balance_save()
  - test_approval_policy_str()

- attendance/views.py
  - test_login()
  - test_apply_leave()
  - test_approve_leave()
```

**階段 2: API 端點測試** (1 週)
```python
# 使用 Django TestCase
class LoginTestCase(TestCase):
    def test_valid_login(self):
        ...
    def test_invalid_password(self):
        ...

class LeaveApplicationTestCase(TestCase):
    def test_apply_leave_success(self):
        ...
    def test_insufficient_balance(self):
        ...
```

**階段 3: 整合測試** (1 週)
```python
# 測試完整流程
class LeaveApprovalFlowTestCase(TestCase):
    def test_single_level_approval(self):
        # 1天請假 -> 主管批准
        ...

    def test_multi_level_approval(self):
        # 4天請假 -> 主管 -> HR -> CEO
        ...
```

**預期效果**:
- 測試覆蓋率 > 80%
- 每次 commit 自動執行測試
- 減少 50% 回歸錯誤

---

## 改進建議

### 功能增強

#### 1. 請假管理系統增強

**建議編號**: REC-001
**優先級**: 🟡 中
**預估效益**: 提升使用者體驗

**建議功能**:

1. **請假取消功能**
   - 允許員工取消尚未批准的請假
   - 已批准的請假需經主管同意才能取消
   - 取消後自動退回假別額度
   - **實施難度**: 低
   - **預估時間**: 3 小時

2. **請假衝突檢查**
   - 申請請假時檢查同時段是否有其他請假記錄
   - 檢查職務代理人是否在職
   - 檢查職務代理人是否同時段也請假
   - **實施難度**: 中
   - **預估時間**: 4 小時

3. **請假範本功能**
   - 允許儲存常用的請假設定（如每月例行休假）
   - 支援快速套用範本
   - **實施難度**: 中
   - **預估時間**: 5 小時

4. **批次請假申請**
   - 一次申請多天不連續的請假
   - 支援匯入 CSV 格式
   - **實施難度**: 高
   - **預估時間**: 8 小時

**實施建議順序**: 1 → 2 → 3 → 4

---

#### 2. 審批系統增強

**建議編號**: REC-002
**優先級**: 🟡 中
**預估效益**: 提升審批效率

**建議功能**:

1. **審批權限委派**
   - 主管可臨時委派審批權限給其他人（如出差、休假時）
   - 設定委派起迄日期
   - 被委派人可代理審批
   - **實施難度**: 中
   - **預估時間**: 6 小時

2. **審批期限設定**
   - 設定審批時限（如 3 個工作天）
   - 超過時限自動提醒或自動核准
   - 記錄審批耗時統計
   - **實施難度**: 中
   - **預估時間**: 5 小時

3. **批次審批功能**
   - 支援一次審批多筆申請
   - 支援快速批准/拒絕
   - 支援批次加註意見
   - **實施難度**: 中
   - **預估時間**: 6 小時

4. **審批規則引擎**
   - 支援更複雜的審批條件（如特定專案、特定時段）
   - 支援自動審批規則（如特定情況自動批准）
   - 支援條件式審批流程
   - **實施難度**: 高
   - **預估時間**: 16 小時

**實施建議順序**: 2 → 3 → 1 → 4

---

#### 3. 打卡系統增強

**建議編號**: REC-003
**優先級**: 🟡 中
**預估效益**: 提升打卡可靠性

**建議功能**:

1. **補打卡功能**
   - 員工忘記打卡可申請補打卡
   - 需主管審批
   - 記錄補打卡原因
   - **實施難度**: 中
   - **預估時間**: 5 小時

2. **打卡異常報表**
   - 統計遲到/早退次數
   - 統計忘記打卡次數
   - 匯出月報表
   - **實施難度**: 中
   - **預估時間**: 6 小時

3. **離線打卡**
   - 支援無網路時打卡
   - 儲存在本地，後續同步
   - 防止重複打卡
   - **實施難度**: 高
   - **預估時間**: 10 小時

4. **打卡照片功能**
   - 打卡時拍照
   - 儲存照片 URL
   - 支援查看打卡照片
   - **實施難度**: 中
   - **預估時間**: 8 小時

**實施建議順序**: 1 → 2 → 4 → 3

---

#### 4. 報表與統計功能

**建議編號**: REC-004
**優先級**: 🟡 中
**預估效益**: 提供管理決策資訊

**建議功能**:

1. **個人出勤統計**
   - 月度出勤統計
   - 遲到/早退次數
   - 工時統計
   - 圖表視覺化
   - **實施難度**: 中
   - **預估時間**: 8 小時

2. **部門請假統計**
   - 部門請假率統計
   - 假別使用分析
   - 請假趨勢分析
   - **實施難度**: 中
   - **預估時間**: 8 小時

3. **審批效率分析**
   - 平均審批時長
   - 審批通過率
   - 審批人員效率統計
   - **實施難度**: 中
   - **預估時間**: 6 小時

4. **匯出功能**
   - 匯出 Excel 報表
   - 匯出 PDF 報表
   - 支援自訂欄位
   - **實施難度**: 中
   - **預估時間**: 8 小時

**實施建議順序**: 1 → 4 → 2 → 3

---

### 安全性增強

#### 5. 身份驗證強化

**建議編號**: REC-005
**優先級**: 🟡 中（部分 🔴 高）
**預估效益**: 提升系統安全性

**建議功能**:

1. **密碼強度驗證** (🔴 高優先級)
   - 最小長度 8 字元
   - 必須包含大小寫字母、數字
   - 建議包含特殊字元
   - 不允許常見密碼
   - **實施難度**: 低
   - **預估時間**: 2 小時

2. **登入失敗次數限制** (🔴 高優先級)
   - 5 次失敗後鎖定帳號 15 分鐘
   - 記錄失敗嘗試的 IP 位址
   - 發送告警郵件給管理員
   - **實施難度**: 中
   - **預估時間**: 4 小時

3. **Session 超時設定** (🔴 高優先級)
   - 設定 SESSION_COOKIE_AGE = 3600 (1 小時)
   - 支援「記住我」功能（延長至 7 天）
   - 閒置 30 分鐘自動登出
   - **實施難度**: 低
   - **預估時間**: 2 小時

4. **雙因素認證 (2FA)**
   - 支援 TOTP（Google Authenticator）
   - 支援 SMS 驗證碼
   - 支援 Email 驗證碼
   - **實施難度**: 高
   - **預估時間**: 16 小時

5. **IP 白名單**
   - 限制特定 IP 範圍可登入
   - 支援動態 IP 管理
   - 異常 IP 告警
   - **實施難度**: 中
   - **預估時間**: 6 小時

**實施建議順序**: 1 → 2 → 3 → 5 → 4

---

#### 6. 資料安全與隱私

**建議編號**: REC-006
**優先級**: 🟡 中
**預估效益**: 符合資料保護規範

**建議功能**:

1. **敏感資料加密**
   - 員工身分證字號加密
   - 銀行帳號加密
   - 個人資料加密
   - **實施難度**: 中
   - **預估時間**: 6 小時

2. **操作日誌記錄**
   - 記錄所有 CRUD 操作
   - 記錄操作人、時間、IP
   - 支援日誌查詢和匯出
   - **實施難度**: 中
   - **預估時間**: 8 小時

3. **資料存取控制**
   - 員工只能查看自己的資料
   - 主管可查看下屬資料
   - HR/CEO 可查看所有資料
   - **實施難度**: 中
   - **預估時間**: 6 小時

4. **個資遮罩**
   - 身分證字號部分遮罩
   - 電話號碼部分遮罩
   - 地址部分遮罩
   - **實施難度**: 低
   - **預估時間**: 3 小時

**實施建議順序**: 3 → 2 → 4 → 1

---

### 效能優化

#### 7. 資料庫效能優化

**建議編號**: REC-007
**優先級**: 🔵 低
**預估效益**: 提升系統回應速度

**建議功能**:

1. **查詢快取**
   - 使用 Redis 快取常用查詢
   - 快取審批政策
   - 快取假別額度
   - **實施難度**: 中
   - **預估時間**: 8 小時

2. **分頁功能**
   - API 回應加入分頁
   - 預設每頁 20 筆
   - 支援自訂頁數
   - **實施難度**: 低
   - **預估時間**: 4 小時

3. **資料歸檔**
   - 自動歸檔 2 年前資料
   - 歸檔資料仍可查詢
   - 減少主表資料量
   - **實施難度**: 中
   - **預估時間**: 10 小時

4. **資料庫索引優化**
   - 分析慢查詢
   - 加入複合索引
   - 移除未使用索引
   - **實施難度**: 低
   - **預估時間**: 4 小時

**實施建議順序**: 2 → 4 → 1 → 3

---

#### 8. API 效能優化

**建議編號**: REC-008
**優先級**: 🔵 低
**預估效益**: 減少 API 回應時間

**建議功能**:

1. **API Rate Limiting**
   - 限制每分鐘請求次數
   - 防止 API 濫用
   - 超過限制回傳 429
   - **實施難度**: 中
   - **預估時間**: 4 小時

2. **回應壓縮**
   - 啟用 GZIP 壓縮
   - 減少傳輸量
   - **實施難度**: 低
   - **預估時間**: 1 小時

3. **資料預載入**
   - 使用 select_related()
   - 使用 prefetch_related()
   - 減少 N+1 查詢問題
   - **實施難度**: 低
   - **預估時間**: 4 小時

4. **非同步處理**
   - 使用 Celery 處理耗時任務
   - 郵件發送非同步化
   - 報表生成非同步化
   - **實施難度**: 高
   - **預估時間**: 12 小時

**實施建議順序**: 3 → 2 → 1 → 4

---

### 使用者體驗優化

#### 9. 通知與提醒

**建議編號**: REC-009
**優先級**: 🟡 中
**預估效益**: 提升使用者滿意度

**建議功能**:

1. **Email 通知**
   - 請假申請提交通知（給審批人）
   - 審批結果通知（給申請人）
   - 審批逾期提醒
   - **實施難度**: 低
   - **預估時間**: 4 小時

2. **站內通知**
   - 即時通知系統
   - 未讀通知提示
   - 通知歷史查詢
   - **實施難度**: 中
   - **預估時間**: 8 小時

3. **行動推播通知**
   - 支援 Firebase Cloud Messaging
   - 支援 Apple Push Notification
   - 可設定通知偏好
   - **實施難度**: 高
   - **預估時間**: 12 小時

4. **LINE 通知整合**
   - 整合 LINE Notify
   - 支援 LINE Bot
   - **實施難度**: 中
   - **預估時間**: 6 小時

**實施建議順序**: 1 → 2 → 4 → 3

---

#### 10. 介面優化

**建議編號**: REC-010
**優先級**: 🔵 低
**預估效益**: 提升使用便利性

**建議功能**:

1. **行動版介面優化**
   - RWD 響應式設計
   - 適配手機螢幕
   - 手勢操作支援
   - **實施難度**: 中
   - **預估時間**: 10 小時

2. **快捷操作**
   - 常用功能快捷鍵
   - 快速批准按鈕
   - 搜尋功能增強
   - **實施難度**: 低
   - **預估時間**: 6 小時

3. **多語言支援**
   - 繁體中文
   - 簡體中文
   - 英文
   - **實施難度**: 高
   - **預估時間**: 20 小時

4. **深色模式**
   - 支援深色主題
   - 自動切換
   - **實施難度**: 中
   - **預估時間**: 8 小時

**實施建議順序**: 1 → 2 → 4 → 3

---

## 實施優先級建議

### 第一階段（上線前必須完成）- 1 週
1. 🔴 **REC-005.1**: 密碼強度驗證 (2h)
2. 🔴 **REC-005.2**: 登入失敗次數限制 (4h)
3. 🔴 **REC-005.3**: Session 超時設定 (2h)
4. 📝 **QA-001 方案 A**: 時數計算文件化 (1h)
5. 📝 完成 API 端點測試 (8h)
6. 📝 建立使用者操作手冊 (8h)

**總時數**: 25 小時

---

### 第二階段（上線後一個月）- 4 週
1. 🟡 **REC-001.1**: 請假取消功能 (3h)
2. 🟡 **REC-001.2**: 請假衝突檢查 (4h)
3. 🟡 **REC-003.1**: 補打卡功能 (5h)
4. 🟡 **REC-003.2**: 打卡異常報表 (6h)
5. 🟡 **REC-006.3**: 資料存取控制 (6h)
6. 🟡 **REC-006.2**: 操作日誌記錄 (8h)
7. 🟡 **REC-009.1**: Email 通知 (4h)
8. 🟡 **REC-009.2**: 站內通知 (8h)
9. 📝 **REC-002**: 單元測試（階段 1-3） (3 週)

**總時數**: 120 小時

---

### 第三階段（上線後三個月）- 8 週
1. 🟡 **REC-002.2**: 審批期限設定 (5h)
2. 🟡 **REC-002.3**: 批次審批功能 (6h)
3. 🟡 **REC-004.1**: 個人出勤統計 (8h)
4. 🟡 **REC-004.4**: 匯出功能 (8h)
5. 🔵 **REC-007.2**: 分頁功能 (4h)
6. 🔵 **REC-007.4**: 資料庫索引優化 (4h)
7. 🔵 **REC-008.3**: 資料預載入 (4h)
8. 🔵 **REC-010.1**: 行動版介面優化 (10h)
9. 🔵 **REC-010.2**: 快捷操作 (6h)

**總時數**: 55 小時

---

### 第四階段（長期優化）- 持續進行
1. 🟡 **REC-002.4**: 審批規則引擎 (16h)
2. 🟡 **REC-004.2**: 部門請假統計 (8h)
3. 🟡 **REC-005.4**: 雙因素認證 (16h)
4. 🔵 **REC-003.3**: 離線打卡 (10h)
5. 🔵 **REC-007.1**: 查詢快取 (8h)
6. 🔵 **REC-008.4**: 非同步處理 (12h)
7. 🔵 **REC-010.3**: 多語言支援 (20h)

**總時數**: 90 小時

---

## 總結

### 立即需要處理的項目（🔴 高優先級）
1. 密碼強度驗證
2. 登入失敗次數限制
3. Session 超時設定

**這些項目涉及系統安全性，建議在正式上線前完成。**

### 短期建議（🟡 中優先級）
1. 請假管理增強（取消、衝突檢查）
2. 補打卡功能
3. 通知系統
4. 資料存取控制
5. 操作日誌

**這些項目可提升使用者體驗和系統可用性，建議在上線後一個月內完成。**

### 長期優化（🔵 低優先級）
1. 效能優化
2. 介面優化
3. 進階功能

**這些項目可根據實際使用情況和使用者反饋，排入後續版本。**

---

**報告結束**

*最後更新: 2025-11-22*
